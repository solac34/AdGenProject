name: Deploy All Services

on:
  push:
    branches: ['main', 'staging']
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      # Optional: these are read by your deploy.sh scripts if set
      WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
      AGENTS_API_TOKEN: ${{ secrets.AGENTS_API_TOKEN }}
      AGENTS_SERVICE_URL: ${{ secrets.AGENTS_SERVICE_URL }}
      WEBAPP_BASE_URL: ${{ secrets.WEBAPP_BASE_URL }}
      ECOMMERCE_SERVICE_URL: ${{ secrets.ECOMMERCE_SERVICE_URL }}
      # Project/region are hardcoded in scripts but kept here for clarity/overrides
      GCP_PROJECT_ID: eighth-upgrade-475017-u5
      GCP_REGION: us-central1

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Activate gcloud account (for gcloud auth list check)
        run: |
          gcloud auth activate-service-account --key-file="${{ steps.auth.outputs.credentials_file_path }}"

      - name: Deploy adg-ecommerce
        working-directory: adg-ecommerce
        run: bash ./deploy.sh

      - name: Deploy Agents
        working-directory: Agents
        run: bash ./deploy.sh

      - name: Deploy AdGen-WebApp
        working-directory: AdGen-WebApp
        run: bash ./deploy.sh

      - name: Deploy agents-cronjob
        working-directory: agents-cronjob
        run: bash ./deploy.sh


